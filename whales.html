<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PigmentOS - Unusual Whales (Expanded)</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #e0e0e0;
            --accent-cyan: #00ffff;
            --accent-purple: #bd00ff;
            --alert-red: #ff3333;
            --font-pixel: 'Press Start 2P', cursive;
            --font-mono: 'JetBrains Mono', monospace;
            --border-color: #333;
            --widget-bg: #111;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-mono);
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .title {
            font-family: var(--font-pixel);
            font-size: 16px;
            color: var(--accent-purple);
            text-shadow: 2px 2px 0px #000;
            cursor: pointer;
            position: relative;
            z-index: 100;
            display: inline-block;
        }

        .back-btn {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-family: var(--font-mono);
            font-size: 10px;
            padding: 4px 8px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Main Layout */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Feed Panel */
        .feed-panel {
            background: var(--widget-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }

        .panel-header {
            background: #1a1a1a;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-family: var(--font-pixel);
            font-size: 12px;
            color: #fff;
        }

        .status-badge {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .status-live {
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
            border: 1px solid #00ff00;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
            animation: pulse-green 2s infinite;
        }

        .status-waiting {
            background: rgba(255, 255, 0, 0.1);
            color: #ffff00;
            border: 1px solid #ffff00;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
            }

            50% {
                box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
            }

            100% {
                box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
            }
        }

        /* Feed List */
        .feed-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .whale-row {
            display: grid;
            grid-template-columns: 0.7fr 0.9fr 1fr 0.5fr 0.5fr 0.5fr 0.4fr;
            align-items: center;
            padding: 8px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 12px;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }

        .whale-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .whale-row.new-row {
            animation: slideIn 0.5s ease-out;
            background: rgba(0, 255, 255, 0.05);
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .col-ticker {
            font-weight: bold;
            color: #fff;
        }

        .col-premium {
            font-family: var(--font-mono);
            font-size: 11px;
        }

        .col-strike {
            display: flex;
            flex-direction: column;
            font-size: 11px;
        }

        .col-time {
            color: #888;
            font-size: 8px;
        }

        .col-tag {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }

        .type-c {
            color: #00ff88;
            /* Green for calls */
        }

        .type-p {
            color: #ff4444;
            /* Red for puts */
        }

        .tag-sweep {
            background: var(--accent-cyan);
            color: #000;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 9px;
            font-weight: bold;
        }

        .tag-dump {
            background: var(--accent-purple);
            color: #fff;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 9px;
            font-weight: bold;
        }

        .tag-bought {
            background: #00ff88;
            color: #000;
            padding: 1px 3px;
            border-radius: 2px;
            font-size: 8px;
            font-weight: bold;
            font-family: 'VT323', monospace;
        }

        .tag-sold {
            background: #ff4444;
            color: #fff;
            padding: 1px 3px;
            border-radius: 2px;
            font-size: 8px;
            font-weight: bold;
            font-family: 'VT323', monospace;
        }

        .tag-mega {
            background: #fff;
            color: #000;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 9px;
            font-weight: bold;
            border: 1px solid var(--accent-purple);
            box-shadow: 0 0 5px var(--accent-purple);
        }

        .mega-row {
            border-left: 3px solid var(--accent-purple);
            background: rgba(189, 0, 255, 0.05);
        }

        .expiry-date {
            font-size: 10px;
            color: #666;
        }

        /* Filter Controls */
        .filter-bar {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            background: #151515;
        }

        .filter-select {
            background: #000;
            color: #fff;
            border: 1px solid #333;
            padding: 5px;
            font-family: var(--font-mono);
            font-size: 11px;
            border-radius: 4px;
        }

        /* Moneyness Badges */
        .tag-itm {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            border: 1px solid rgba(0, 255, 0, 0.3);
            padding: 0px 2px;
            border-radius: 2px;
            font-size: 7px;
        }

        .tag-otm {
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0px 2px;
            border-radius: 2px;
            font-size: 7px;
        }

        .tag-atm {
            background: rgba(255, 51, 51, 0.2);
            color: #FF3333;
            border: 1px solid rgba(255, 51, 51, 0.3);
            padding: 0px 2px;
            border-radius: 2px;
            font-size: 7px;
        }

        .col-time {
            font-size: 10px;
            color: #666;
        }

        .time-ago-now {
            background: var(--accent-cyan);
            color: #000;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 9px;
            font-weight: bold;
        }

        /* Delta Gauge Styles (Matched to Main Feed) */
        .delta-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-right: 6px;
        }

        .delta-label {
            font-size: 8px;
            color: #888;
            font-family: 'VT323', monospace;
            min-width: 20px;
            text-align: right;
        }

        .delta-bar-mini {
            width: 28px;
            height: 4px;
            background: #ff4444;
            border: 1px solid #333;
            position: relative;
            overflow: hidden;
        }

        .delta-bar-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: #00ff88;
        }

        /* Stats Panel */
        .stats-panel {
            background: var(--widget-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .stats-container {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
        }

        .stat-value {
            font-family: var(--font-pixel);
            font-size: 12px;
            color: #fff;
        }

        .bullish {
            color: var(--accent-cyan);
        }

        .bearish {
            color: var(--accent-purple);
        }

        /* Top Tickers List */
        .top-tickers {
            margin-top: 10px;
        }

        .ticker-item {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .ticker-count {
            color: #888;
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Mobile Responsive Styles */
        @media (max-width: 480px) {
            .whale-row {
                grid-template-columns: 1fr 1fr 1.2fr 0.8fr 0.6fr;
                padding: 6px 10px;
                font-size: 10px;
                gap: 4px;
            }

            .col-delta {
                display: none;
                /* Hide delta on very small screens */
            }

            .col-time {
                display: none;
                /* Hide time on very small screens */
            }

            .col-premium {
                font-size: 10px;
            }

            .col-strike {
                font-size: 10px;
            }

            .delta-wrapper {
                margin-right: 2px;
            }

            .delta-bar-mini {
                width: 20px;
                height: 3px;
            }

            .delta-label {
                font-size: 7px;
                min-width: 16px;
            }
        }

        /* Tablet responsive (480-768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            .whale-row {
                grid-template-columns: 0.6fr 0.8fr 1fr 0.5fr 0.5fr 0.5fr 0.4fr;
                padding: 6px 12px;
                font-size: 11px;
            }

            .delta-bar-mini {
                width: 24px;
                height: 4px;
            }
        }
    </style>
    <link
        href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=JetBrains+Mono:wght@400;700&family=VT323&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="header">
        <a href="/unusual_flow" class="title" style="text-decoration: none;">UNUSUAL WHALES // EXPANDED</a>
        <a href="/" class="back-btn">Back to Dashboard</a>
    </div>

    <div class="main-content">
        <!-- Stats Panel (Top on mobile, Side on desktop) -->
        <div class="stats-panel">
            <div class="panel-header">
                <span class="panel-title">SESSION STATS</span>
            </div>
            <div class="stats-container">
                <div class="stat-item">
                    <span class="stat-label">TOTAL PREMIUM</span>
                    <span class="stat-value" id="total-premium">$0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">FLOW RATIO</span>
                    <span class="stat-value" id="flow-ratio">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">MEGA WHALES</span>
                    <span class="stat-value" id="mega-count">0</span>
                </div>

                <div class="top-tickers" id="top-tickers">
                    <!-- Top tickers inserted here -->
                </div>

                <div style="margin-top: 10px; font-size: 10px; color: #666;">
                    <span id="calls-premium">Calls: $0</span><br>
                    <span id="puts-premium">Puts: $0</span>
                </div>
            </div>
        </div>

        <!-- Feed Panel -->
        <div class="feed-panel">
            <div class="panel-header">
                <span class="panel-title">LIVE FEED</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="item-count" style="font-size: 10px; color: #666;">0 trades</span>
                    <span
                        style="font-size: 10px; padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.1); color: #888; letter-spacing: 1px;">30
                        DTE</span>
                    <span class="status-badge status-waiting" id="status-badge">WAITING</span>
                </div>
            </div>

            <div class="filter-bar">
                <select id="ticker-selector" class="filter-select">
                    <option value="" selected disabled>SELECT TICKER</option>
                    <option value="NVDA">NVDA</option>
                    <option value="TSLA">TSLA</option>
                    <option value="AAPL">AAPL</option>
                    <option value="AMD">AMD</option>
                    <option value="AMZN">AMZN</option>
                    <option value="MSFT">MSFT</option>
                    <option value="META">META</option>
                    <option value="GOOGL">GOOGL</option>
                    <option value="PLTR">PLTR</option>
                    <option value="MU">MU</option>
                </select>
                <select id="dte-selector" class="filter-select">
                    <option value="" selected disabled>SELECT DTE</option>
                    <!-- Expiry dates populated from ticker data -->
                </select>
            </div>

            <div class="feed-container" id="feed-container">
                <!-- Trades inserted here -->
            </div>
        </div>
    </div>

    <script>
        const feedContainer = document.getElementById('feed-container');
        const statusBadge = document.getElementById('status-badge');
        const itemCount = document.getElementById('item-count');
        const tickerSelector = document.getElementById('ticker-selector');
        const dteSelector = document.getElementById('dte-selector');

        // Stats Elements
        const totalPremiumEl = document.getElementById('total-premium');
        const flowRatioEl = document.getElementById('flow-ratio');
        const megaCountEl = document.getElementById('mega-count');
        const topTickersEl = document.getElementById('top-tickers');
        const callsPremiumEl = document.getElementById('calls-premium');
        const putsPremiumEl = document.getElementById('puts-premium');

        let evtSource = null;
        let allTrades = [];
        const MAX_TRADES = 200;
        const seenTrades = new Set();
        let selectedTicker = ''; // Start empty
        let selectedExpiry = ''; // DTE filter (empty = show all initially)
        const API_BASE_URL = window.location.origin;

        // DTE selector is now populated dynamically from ticker data
        function populateDTEFromTrades(trades) {
            // Clear existing options
            dteSelector.innerHTML = '<option value="" selected disabled>SELECT DTE</option>';

            // Get unique expiry dates from trades
            const expiries = [...new Set(trades.map(t => t.expiry))].sort();

            expiries.forEach(exp => {
                const opt = document.createElement('option');
                opt.value = exp;
                // Format: "Jan 10" from "2026-01-10"
                const d = new Date(exp + 'T12:00:00');
                opt.textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                dteSelector.appendChild(opt);
            });

            // Auto-select first expiry if available
            if (expiries.length > 0) {
                selectedExpiry = expiries[0];
                dteSelector.value = selectedExpiry;
            }
        }

        // DTE Selector Logic
        dteSelector.addEventListener('change', (e) => {
            selectedExpiry = e.target.value;
            renderFeed();
            updateStats();
        });

        // Ticker Selector Logic
        tickerSelector.addEventListener('change', (e) => {
            selectedTicker = e.target.value;

            // Reset Feed
            allTrades = [];
            seenTrades.clear();

            // Show loading state
            statusBadge.textContent = 'LOADING';
            statusBadge.className = 'status-badge status-waiting';
            feedContainer.innerHTML = '<div class="loading-message"><div class="spinner"></div><div>Fetching Options Flow...</div></div>';

            // Fetch Library Data (replaces SSE stream)
            fetchLibraryData(selectedTicker);
        });

        function initStream() {
            if (evtSource) {
                evtSource.close();
            }

            if (!selectedTicker) {
                showEmptyState();
                return;
            }

            statusBadge.textContent = 'CONNECTING';
            statusBadge.className = 'status-badge status-waiting';

            // Connect to 30DTE stream
            evtSource = new EventSource(`${API_BASE_URL}/api/whales/30dte/stream`);

            evtSource.onmessage = function (event) {
                const data = JSON.parse(event.data);
                handleWhaleData(data);
            };

            evtSource.onerror = function (err) {
                console.error("EventSource failed:", err);
                statusBadge.textContent = 'ERROR';
                statusBadge.className = 'status-badge status-waiting';
                evtSource.close();
                // Retry in 5s
                setTimeout(initStream, 5000);
            };
        }

        function handleWhaleData(data) {
            if (document.hidden) return; // Optimization

            // Update Status
            const now = new Date();
            const isMarketOpen = (now.getDay() >= 1 && now.getDay() <= 5) &&
                (now.getHours() >= 9 && now.getHours() < 16) ||
                (now.getHours() === 16 && now.getMinutes() < 15); // Until 4:15 ET

            if (!isMarketOpen) {
                statusBadge.textContent = 'CLOSED';
                statusBadge.className = 'status-badge status-waiting';
            } else {
                statusBadge.textContent = 'LIVE';
                statusBadge.className = 'status-badge status-live';
            }

            if (!data || data.length === 0) {
                if (allTrades.length === 0) showEmptyState();
                return;
            }

            // Clear loading message
            const loadingMsg = feedContainer.querySelector('.loading-message');
            if (loadingMsg) loadingMsg.remove();

            // Process trades
            const nowTs = Date.now() / 1000;
            let hasNewTrades = false;

            data.forEach(item => {
                const ticker = item.baseSymbol || item.symbol;
                const strike = item.strikePrice;
                const type = item.putCall === 'C' ? 'CALL' : 'PUT';
                const expiry = item.expirationDate;
                const volume = item.volume;
                const tradeId = `${ticker}_${strike}_${type}_${expiry}_${volume}`;

                if (seenTrades.has(tradeId)) return;
                seenTrades.add(tradeId);
                hasNewTrades = true;

                const trade = {
                    id: tradeId,
                    ticker,
                    strike,
                    type,
                    expiry,
                    premium: item.premium || 'DELAYED',
                    volume,
                    notional_value: item.notional_value || 0,
                    is_mega_whale: item.is_mega_whale || false,
                    timestamp: item.timestamp || nowTs,
                    delta: item.delta,
                    side: item.side,
                    bid: item.bid,
                    ask: item.ask,
                    lastPrice: item.lastPrice || 0,
                    moneyness: item.moneyness
                };

                allTrades.unshift(trade);
            });

            // Trim to max
            if (allTrades.length > MAX_TRADES) {
                allTrades = allTrades.slice(0, MAX_TRADES);
            }

            if (hasNewTrades) {
                renderFeed();
                updateStats();
            }
        }

        function showEmptyState() {
            if (!selectedTicker) {
                feedContainer.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #666;">
                        <div style="font-size: 40px; margin-bottom: 20px;">üê≥</div>
                        <div style="font-family: var(--font-pixel); font-size: 14px; margin-bottom: 10px; color: var(--accent-cyan);">SELECT A TICKER</div>
                        <div style="font-size: 12px;">Choose a ticker from the menu to view live options flow and upcoming library.</div>
                    </div>
                `;
            } else {
                feedContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 10px;">üê≥</div>
                        <div>No active 0-30 DTE trades available for ${selectedTicker}</div>
                    </div>
                `;
            }
        }

        function renderFeed() {
            feedContainer.innerHTML = '';

            const filteredTrades = allTrades.filter(trade => {
                // Ticker filter (always matches since we fetch per-ticker)
                if (selectedTicker && selectedTicker !== 'ALL' && trade.ticker !== selectedTicker) {
                    return false;
                }
                // Expiry filter (empty = show all, otherwise match specific expiry)
                if (selectedExpiry && trade.expiry !== selectedExpiry) {
                    return false;
                }
                return true;
            });

            if (filteredTrades.length === 0) {
                feedContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        No trades found for ${selectedTicker}
                    </div>
                `;
                itemCount.textContent = `0 trades`;
                return;
            }

            filteredTrades.forEach((trade, index) => {
                const row = createTradeRow(trade, index === 0);
                feedContainer.appendChild(row);
            });

            itemCount.textContent = `${filteredTrades.length} trades`;
        }

        function createTradeRow(trade, isNew) {
            const row = document.createElement('div');
            row.className = 'whale-row';

            if (isNew) row.classList.add('new-row');

            const isCall = trade.type === 'CALL';
            const isPut = trade.type === 'PUT';
            row.classList.add(isCall ? 'call-row' : 'put-row');

            // Check for SWEEP (from backend - condition "I" = Intermarket Sweep)
            const notional = trade.notional_value || 0;
            const isSweep = trade.is_sweep === true;

            if (trade.is_mega_whale || isSweep) {
                row.classList.add('mega-row');
            }

            const typeClass = isCall ? 'type-c' : 'type-p';
            const typeLabel = isCall ? 'C' : 'P';
            const dateStr = trade.expiry ? trade.expiry.slice(5) : '';

            // === MONEYNESS BADGE ===
            let moneynessHtml = '';
            if (trade.moneyness) {
                let moneyClass = 'tag-otm';
                if (trade.moneyness === 'ITM') moneyClass = 'tag-itm';
                if (trade.moneyness === 'ATM') moneyClass = 'tag-atm';
                moneynessHtml = `<span class="${moneyClass}">${trade.moneyness}</span>`;
            }

            // === TAG LOGIC (Simplified Priority) ===
            let tagHtml = '';
            /* TAGS HIDDEN PER USER REQUEST
            const isMega = trade.is_mega_whale;

            if (isSweep) {
                tagHtml = '<span class="tag-sweep">SWEEP</span>';
            } else if (isDump) {
                tagHtml = '<span class="tag-dump">DUMP</span>';
            } else if (isMega) {
                tagHtml = '<span class="tag-mega">MEGA</span>';
            } else if (isCall) {
                tagHtml = '<span class="tag-bull">BULL</span>';
            } else {
                tagHtml = '<span class="tag-bear">BEAR</span>';
            }
            */

            // === DELTA BAR (Restored Production Style) ===
            let deltaHtml = '';
            const delta = trade.delta || 0;
            const deltaPercent = Math.min(Math.abs(delta * 100), 100);
            // Format: .65 instead of 0.65
            const deltaLabel = Math.abs(delta).toFixed(2).replace(/^0+/, '');

            deltaHtml = `
                <div class="delta-wrapper">
                    <span class="delta-label">${deltaLabel}</span>
                    <div class="delta-bar-mini">
                        <div class="delta-bar-fill" style="width: ${deltaPercent}%;"></div>
                    </div>
                </div>
            `;

            // Time Display Logic
            const tradeDate = new Date(trade.timestamp * 1000);
            const now = new Date();
            const isToday = tradeDate.getDate() === now.getDate() &&
                tradeDate.getMonth() === now.getMonth() &&
                tradeDate.getFullYear() === now.getFullYear();

            let timeStr = '';

            if (isToday) {
                // Show relative time (hours/mins ago)
                const secsAgo = Math.floor(Date.now() / 1000 - trade.timestamp);
                if (secsAgo < 60) timeStr = `${secsAgo}s`;
                else if (secsAgo < 3600) timeStr = `${Math.floor(secsAgo / 60)}m`;
                else timeStr = `${Math.floor(secsAgo / 3600)}h`;
            } else {
                // Show Date in MM/DD format (e.g. "01/06")
                const mm = String(tradeDate.getMonth() + 1).padStart(2, '0');
                const dd = String(tradeDate.getDate()).padStart(2, '0');
                timeStr = `${mm}/${dd}`;
            }

            // Show contract size and side badge
            const size = trade.size || 0;
            const side = trade.side; // Can be null/undefined now

            let sideBadge = '';
            if (side === 'BUY') {
                sideBadge = `<span class="tag-bought" style="margin-left: 4px;">BUY</span>`;
            } else if (side === 'SELL') {
                sideBadge = `<span class="tag-sold" style="margin-left: 4px;">SELL</span>`;
            }

            let sweepBadge = isSweep ? '<span style="color: var(--accent-cyan); font-size: 9px; margin-left: 4px;">‚ö°SWEEP</span>' : '';
            let sizeHtml = `<span style="color: #888; font-size: 10px;">${size} cts</span>${sideBadge}`;

            row.innerHTML = `
                <div class="col-ticker">${trade.ticker}</div>
                <div class="col-premium ${typeClass}">${trade.premium}</div>
                <div class="col-strike">
                    <span class="${typeClass}">${trade.strike}${typeLabel}</span>
                    <span class="expiry-date">${dateStr}</span>
                </div>
                <div class="col-delta">${deltaHtml}</div>
                <div class="col-side">${sizeHtml}</div>
                <div class="col-moneyness">${moneynessHtml}${sweepBadge}</div>
                <div class="col-time">${timeStr}</div>
            `;

            return row;
        }

        function updateStats() {
            // Filter trades for stats (same filter as renderFeed)
            const filteredTrades = allTrades.filter(trade => {
                if (selectedTicker && selectedTicker !== 'ALL' && trade.ticker !== selectedTicker) {
                    return false;
                }
                if (selectedExpiry && trade.expiry !== selectedExpiry) {
                    return false;
                }
                return true;
            });

            let totalCallPremium = 0;
            let totalPutPremium = 0;
            let megaCount = 0;
            const tickerCounts = {};

            filteredTrades.forEach(trade => {
                // Parse premium (e.g., "$1.2M" -> 1200000)
                const premiumStr = trade.premium.replace(/[$,]/g, '');
                let premium = 0;
                if (premiumStr.includes('M')) {
                    premium = parseFloat(premiumStr) * 1000000;
                } else if (premiumStr.includes('K')) {
                    premium = parseFloat(premiumStr) * 1000;
                } else if (!isNaN(parseFloat(premiumStr))) {
                    premium = parseFloat(premiumStr);
                }

                if (trade.type === 'CALL') {
                    totalCallPremium += premium;
                } else {
                    totalPutPremium += premium;
                }

                if (trade.is_mega_whale) megaCount++;

                tickerCounts[trade.ticker] = (tickerCounts[trade.ticker] || 0) + 1;
            });

            const totalPremium = totalCallPremium + totalPutPremium;

            // Format values
            totalPremiumEl.textContent = formatPremium(totalPremium);
            callsPremiumEl.innerHTML = `<span style="color: #00ff88;">Calls:</span> <span style="color: #fff;">${formatPremium(totalCallPremium)}</span>`;
            putsPremiumEl.innerHTML = `<span style="color: #ff4444;">Puts:</span> <span style="color: #fff;">${formatPremium(totalPutPremium)}</span>`;
            megaCountEl.textContent = megaCount.toString();

            // Flow ratio
            if (totalPremium > 0) {
                const callPct = Math.round((totalCallPremium / totalPremium) * 100);
                if (callPct > 55) {
                    flowRatioEl.textContent = `${callPct}% CALLS`;
                    flowRatioEl.className = 'stat-value bullish';
                } else if (callPct < 45) {
                    flowRatioEl.textContent = `${100 - callPct}% PUTS`;
                    flowRatioEl.className = 'stat-value bearish';
                } else {
                    flowRatioEl.textContent = 'BALANCED';
                    flowRatioEl.className = 'stat-value';
                }
            } else {
                flowRatioEl.textContent = '-';
            }

            // Top Tickers (only show if ALL is selected, otherwise show just selected)
            topTickersEl.innerHTML = '';

            if (selectedTicker !== 'ALL') {
                const row = document.createElement('div');
                row.className = 'ticker-item';
                row.innerHTML = `
                    <span class="ticker-symbol">${selectedTicker}</span>
                    <span class="ticker-count">${tickerCounts[selectedTicker] || 0} trades</span>
                `;
                topTickersEl.appendChild(row);
            } else {
                const sortedTickers = Object.entries(tickerCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                sortedTickers.forEach(([ticker, count]) => {
                    const row = document.createElement('div');
                    row.className = 'ticker-item';
                    row.innerHTML = `
                        <span class="ticker-symbol">${ticker}</span>
                        <span class="ticker-count">${count} trades</span>
                    `;
                    topTickersEl.appendChild(row);
                });
            }
        }

        function formatPremium(value) {
            if (value >= 1000000) {
                return `$${(value / 1000000).toFixed(1)}M`;
            } else if (value >= 1000) {
                return `$${(value / 1000).toFixed(0)}K`;
            }
            return `$${value.toFixed(0)}`;
        }



        async function fetchLibraryData(ticker) {
            if (!ticker) {
                showEmptyState();
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/api/library/options?symbol=${ticker}`);
                const json = await res.json();

                if (json.error) throw new Error(json.error);

                // Convert trade-by-trade format and populate main feed
                const trades = json.data || [];
                allTrades = trades.map((t, idx) => ({
                    id: `${t.ticker}_${t.strike}_${t.type}_${t.expiry}_${t.timestamp}_${idx}`,
                    ticker: t.ticker,
                    strike: t.strike,
                    type: t.type,
                    expiry: t.expiry,
                    premium: t.premium,
                    size: t.size,  // Contracts in this trade
                    price: t.price,  // Trade price
                    notional_value: t.notional_value,
                    is_mega_whale: t.notional_value >= 1000000,
                    is_sweep: t.is_sweep,  // Intermarket sweep indicator
                    timestamp: t.timestamp,
                    moneyness: t.moneyness,
                    timeStr: t.timeStr,
                    condition: t.condition,
                    exchange: t.exchange,
                    delta: t.delta,  // Delta from Alpaca Greeks
                    side: t.side
                }));

                // Populate DTE selector with actual expiry dates from this ticker
                populateDTEFromTrades(allTrades);

                // Update status
                statusBadge.textContent = 'LOADED';
                statusBadge.className = 'status-badge status-live';

                // Render
                renderFeed();
                updateStats();

            } catch (e) {
                feedContainer.innerHTML = `<div style="color: var(--alert-red); text-align: center; padding: 20px;">Error: ${e.message}</div>`;
                statusBadge.textContent = 'ERROR';
                statusBadge.className = 'status-badge status-waiting';
            }
        }

        // Initialize
        showEmptyState();
        // initStream(); // Wait for user selection
    </script>

    <!-- Firebase Auth (Required for Production) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCEtjs3kYaB7usZjplg797NYtM4MFIdm7g",
            authDomain: "pigmentos-49d50.firebaseapp.com",
            projectId: "pigmentos-49d50",
            storageBucket: "pigmentos-49d50.firebasestorage.app",
            messagingSenderId: "52957674554",
            appId: "1:52957674554:web:2a3b295c23978980a6c903",
            measurementId: "G-RDE19D05G2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

            if (!user && !isLocal) {
                window.location.href = '/login.html';
            }
        });
    </script>
</body>

</html>