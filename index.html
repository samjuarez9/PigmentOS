<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIGMENT OS</title>
    <meta name="description" content="Real-time Financial Intelligence Dashboard">
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <link rel="stylesheet" href="styles.css?v=3.20">
    <link
        href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">

    <script defer src="https://s3.tradingview.com/tv.js"></script>
    <script defer src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>

<body style="visibility: hidden;">
    <!-- Loading Screen (Retro 16-bit style) -->
    <div id="loading-screen" style="
        visibility: visible;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0a0a0a;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        font-family: 'VT323', monospace;
    ">
        <div style="
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top: 4px solid #9D4EDD;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        "></div>
        <div style="
            margin-top: 20px;
            color: #9D4EDD;
            font-size: 18px;
            letter-spacing: 3px;
        ">INITIALIZING...</div>
        <style>
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </div>
    <div class="terminal-container">
        <!-- Header -->
        <header class="main-header">
            <div class="brand-container">
                <span class="brand-icon">‚ùñ</span>
                <div class="brand-text">
                    <span class="pigment-word">PIGMENT</span>
                    <span class="os-word">OS</span>
                </div>
                <div class="brand-subtitle">
                    <span class="subtitle-text">Powered by</span>
                    <div class="polymarket-badge">
                        <img src="assets/polymarket_logo.png" alt="Polymarket" class="poly-logo-img">
                    </div>
                </div>
            </div>

            <!-- Ticker moved to footer -->

            <!-- LIVE Indicator placeholder (will be on right) -->
            <div class="header-right">

                <!-- Global Market Sessions -->
                <div id="market-sessions">
                    <div class="session-item" id="session-ny">
                        <div class="session-info">
                            <span class="session-flag">üá∫üá∏</span>
                            <span class="session-name">NY</span>
                        </div>
                        <div class="session-bar-container">
                            <div class="session-bar"></div>
                        </div>
                    </div>
                    <div class="session-item" id="session-lon">
                        <div class="session-info">
                            <span class="session-flag">üá¨üáß</span>
                            <span class="session-name">LON</span>
                        </div>
                        <div class="session-bar-container">
                            <div class="session-bar"></div>
                        </div>
                    </div>
                    <div class="session-item" id="session-tok">
                        <div class="session-info">
                            <span class="session-flag">üáØüáµ</span>
                            <span class="session-name">TOK</span>
                        </div>
                        <div class="session-bar-container">
                            <div class="session-bar"></div>
                        </div>
                    </div>
                    <div class="session-item" id="session-syd">
                        <div class="session-info">
                            <span class="session-flag">üá¶üá∫</span>
                            <span class="session-name">SYD</span>
                        </div>
                        <div class="session-bar-container">
                            <div class="session-bar"></div>
                        </div>
                    </div>
                </div>

                <div class="financial-disclaimer">For educational and research purposes and not financial advice
                </div>
                <div id="manage-billing-btn" class="billing-link" style="display: none;">[MANAGE BILLING]</div>
                <div class="clock-date-container">
                    <div id="clock" class="clock">00:00:00</div>
                    <div id="date" class="date">MON, JAN 1</div>
                </div>
            </div>

        </header>

        <!-- NEWS FEED -->


        <!-- Main Grid -->
        <main class="main-grid">
            <!-- Left Column -->
            <div class="column left-col">
                <div class="widget" id="unusual-whales">
                    <div class="widget-header">
                        <!-- <a href="/unusual_flow" style="text-decoration: none;"> -->
                        <h2 id="whale-widget-title">UNUSUAL WHALES <span class="whale-emoji">üê≥</span></h2>
                        <!-- </a> -->
                        <button id="market-status-btn" class="market-status-btn after-market">AFTER MARKET</button>
                        <div class="status-container" id="status-whales">
                            <span class="status-text">LIVE</span>
                        </div>
                        <div class="decoration-line"></div>
                    </div>
                    <div class="widget-content list-container" id="flow-feed-container">
                        <!-- Populated by JS -->
                        <div class="placeholder-item">Scanning for High Value Flow...</div>
                    </div>
                </div>

                <div class="widget" id="gamma-wall">
                    <div class="widget-header">
                        <h2>GAMMA WALL</h2>
                        <!-- Gamma Ticker Selector -->
                        <select id="gamma-ticker-select" class="retro-selector" style="margin-left: 10px;">
                            <option value="SPY">SPY</option>
                            <option value="QQQ">QQQ</option>
                            <option value="NVDA">NVDA</option>
                            <option value="TSLA">TSLA</option>
                            <option value="AAPL">AAPL</option>
                            <option value="MSFT">MSFT</option>
                            <option value="AMD">AMD</option>
                            <option value="AMZN">AMZN</option>
                            <option value="GOOGL">GOOGL</option>
                            <option value="META">META</option>
                            <option value="PLTR">PLTR</option>
                            <option value="MU">MU</option>
                            <option value="ORCL">ORCL</option>
                            <option value="TSM">TSM</option>
                            <option value="LITE">LITE</option>
                            <option value="SNDK">SNDK</option>
                        </select>
                        <div class="status-container" id="status-gamma-wall">
                            <span class="status-text">LIVE</span>
                        </div>
                        <div class="decoration-line"></div>
                    </div>
                    <div class="widget-content chart-container" id="gamma-container">
                        <div class="gamma-chart-wrapper crt-effect">
                            <div class="gamma-axis-label gamma-axis-top">
                                <span>‚óÄ PUTS</span>
                                <span id="gamma-dte-display" class="gamma-dte-text"></span>
                                <span>CALLS ‚ñ∂</span>
                            </div>
                            <div id="gamma-chart-bars"></div>
                            <div class="gamma-axis-label">
                                <span>PUTS (BEARISH)</span>
                                <span>CALLS (BULLISH)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Column -->
            <div class="column center-col">
                <div class="news-feed-container" id="news-feed-container">
                    <div class="news-header intel-bar">
                        <div class="intel-row">
                            <!-- Static Left Side: INTEL Label + HOT/COLD indicator -->
                            <div class="intel-left">
                                <div class="intel-title">INTEL</div>
                            </div>
                            <!-- Scrollable Ticker Area -->
                            <div class="intel-scroll">
                                <div class="intel-scroll-inner" id="price-ticker">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                            <!-- Controls (right side, static) -->
                            <div id="auto-scroll-indicator" class="scroll-control">[SCROLL]</div>
                        </div>
                    </div>
                    <div id="news-items-list">
                        <div id="news-track">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="widget large-widget" id="live-price-action">
                    <div class="widget-header">
                        <div class="header-left-group">
                            <h2>üí∏ PRICE ACTION</h2>
                            <!-- Custom Ticker Dropdown (Next to title) -->
                            <select id="ticker-select" class="retro-selector">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="status-container" id="status-chart">
                            <span class="status-dot">‚óè</span>
                            <span class="status-text">OFFLINE</span>
                        </div>
                        <div class="decoration-line"></div>
                    </div>
                    <div class="widget-content chart-container" id="chart-container">
                        <!-- Chart rendered here -->
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="column right-col">
                <div class="widget" id="polymarket-odds">
                    <div class="widget-header">
                        <h2>üîÆ POLYMARKET ODDS</h2>
                        <div class="status-container" id="status-polymarket">
                            <span class="status-text">OFFLINE</span>
                        </div>
                        <div class="decoration-line"></div>
                    </div>
                    <div class="widget-content list-container" id="polymarket-container">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="widget" id="trader-fear-index">
                    <div class="widget-header">
                        <h2>üé≠ TRADER FEAR INDEX</h2>
                        <div class="status-container" id="status-tfi">
                            <span class="status-dot">‚óè</span>
                            <span class="status-text">LIVE</span>
                        </div>
                        <div class="decoration-line"></div>
                    </div>
                    <div class="widget-content">
                        <div class="tfi-container">
                            <div class="tfi-display">
                                <div class="tfi-score" id="tfi-score">50</div>
                                <div class="tfi-rating" id="tfi-rating">NEUTRAL</div>
                                <div class="tfi-vix-ref" id="tfi-vix-ref">VIX: --</div>
                            </div>
                            <div class="tfi-bar-chart" id="tfi-segments">
                                <!-- 10 Segments -->
                                <div class="tfi-seg"></div>
                                <div class="tfi-seg"></div>
                                <div class="tfi-seg"></div>
                                <div class="tfi-seg"></div>
                                <div class="tfi-seg"></div>
                                <div class="tfi-seg"></div>
                                <div class="tfi-seg"></div>
                                <div class="tfi-seg"></div>
                                <div class="tfi-seg"></div>
                                <div class="tfi-seg"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="widget" id="sector-heatmap">
                    <div class="widget-header">
                        <h2>MARKET MAP</h2>
                        <div class="header-controls"
                            style="display: flex; align-items: center; gap: 10px; margin-left: auto; margin-right: 10px;">
                            <div id="sector-scroll-btn" class="auto-scroll-btn style-success">
                                <span id="sector-scroll-text">VIEW: ALL</span>
                            </div>
                        </div>
                        <div class="status-container" id="status-sectors">
                            <span class="status-dot">‚óè</span>
                            <span class="status-text">LIVE</span>
                        </div>
                        <div class="decoration-line"></div>
                    </div>
                    <div class="widget-content">
                        <div class="heatmap-grid" id="heatmap-grid">
                            <!-- Populated by JS -->
                            <div class="heatmap-item loading">LOADING...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Ticker Widget - Moved to Intel Feed Header -->
    </div>

    <!-- ECONOMIC EVENT CALENDAR MODAL (Retro CRT Style) -->
    <div id="economic-calendar-modal" class="retro-modal hidden">
        <div class="modal-overlay"></div>
        <div class="crt-window">
            <div class="crt-header">
                <span class="crt-title">‚ö†Ô∏è CRITICAL EVENTS LOG</span>
                <button id="close-calendar-btn" class="crt-close-btn">[X]</button>
            </div>
            <div class="crt-content">
                <div class="scanline-overlay"></div>

                <div class="event-list-header">
                    <span class="crt-status">STATUS: <span class="status-active">ACTIVE</span></span>
                </div>
                <div id="economic-event-list" class="retro-list">
                    <!-- Populated by JS -->
                </div>
                <div class="crt-footer">
                    <span>PRESS ESC TO CLOSE</span>
                </div>
            </div>
        </div>
    </div>

    <!-- System Diagnostics - Minimal WiFi + Latency -->
    <div id="connection-monitor" class="diag-inline">
        <div class="wifi-signal" id="wifi-bars">
            <div class="wifi-bar" data-bar="1"></div>
            <div class="wifi-bar" data-bar="2"></div>
            <div class="wifi-bar" data-bar="3"></div>
            <div class="wifi-bar" data-bar="4"></div>
        </div>
        <div class="inline-metric" id="latency-value">--ms</div>
        <div id="vip-badge" class="vip-badge" style="display: none;">üëë VIP</div>
    </div>

    <!-- X (Twitter) Link Button - Fixed below Diagnostics -->
    <a href="https://x.com/ospigment?s=11" target="_blank" id="x-link-btn" class="x-fixed-btn">
        <svg viewBox="0 0 24 24" width="10" height="10" fill="currentColor">
            <path
                d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z">
            </path>
        </svg>
        <span>FOLLOW</span>
    </a>



    <!-- Sign Out Button - Fixed below X/Discord -->
    <button id="sign-out-btn" class="sign-out-btn">SIGN OUT</button>

    <!-- Support Text -->
    <div class="support-text">Questions? DM us on X</div>

    <script src="app.js?v=3.29"></script>

    <!-- Trial Tracking & Auth -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics, logEvent, setUserProperties } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCEtjs3kYaB7usZjplg797NYtM4MFIdm7g",
            authDomain: "pigmentos-49d50.firebaseapp.com",
            projectId: "pigmentos-49d50",
            storageBucket: "pigmentos-49d50.firebasestorage.app",
            messagingSenderId: "52957674554",
            appId: "1:52957674554:web:2a3b295c23978980a6c903",
            measurementId: "G-RDE19D05G2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // SAFETY TIMEOUT: Force-show page after 3s even if Firebase is slow
        // This prevents navigation hang when Firebase SDK takes too long to initialize
        const safetyTimeout = setTimeout(() => {
            console.warn('‚ö†Ô∏è Firebase took too long - force-showing page');
            hideLoadingScreen();
            document.body.style.visibility = 'visible';
        }, 3000);

        // Track page view
        logEvent(analytics, 'page_view', { page_title: 'Dashboard' });

        // Make analytics available globally for custom events
        window.pigmentAnalytics = { logEvent, setUserProperties, analytics };

        // Sign Out Logic
        const signOutBtn = document.getElementById('sign-out-btn');
        if (signOutBtn) {
            signOutBtn.addEventListener('click', () => {
                logEvent(analytics, 'sign_out', { location: 'dashboard' });
                signOut(auth).then(() => {
                    window.location.href = '/login.html';
                }).catch((error) => {
                    console.error('Sign Out Error', error);
                });
            });
        }

        function setupBillingButton(user) {
            const billingBtn = document.getElementById('manage-billing-btn');
            if (!billingBtn) return;

            // If no user (Dev Mode), show disabled or hide
            if (!user) {
                billingBtn.style.display = 'block';
                billingBtn.style.opacity = '0.5';
                billingBtn.onclick = () => alert('Billing not available in Dev Mode');
                return;
            }

            billingBtn.style.display = 'block';
            billingBtn.onclick = async () => {
                try {
                    const originalText = billingBtn.innerText;
                    billingBtn.innerText = '[LOADING...]';
                    const idToken = await user.getIdToken();
                    const response = await fetch('/api/create-portal-session', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${idToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email: user.email })
                    });
                    const data = await response.json();
                    if (data.url) {
                        window.location.href = data.url;
                    } else {
                        alert('Error: ' + (data.error || 'Could not create portal session'));
                        billingBtn.innerText = originalText;
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error connecting to billing portal');
                    billingBtn.innerText = '[MANAGE BILLING]';
                }
            };
        }

        onAuthStateChanged(auth, async (user) => {
            // CLEAR SAFETY TIMEOUT since we have a response
            clearTimeout(safetyTimeout);

            // DEV MODE BYPASS
            const isDevMode = localStorage.getItem('devMode') === 'true' ||
                window.location.hostname === 'localhost' ||
                window.location.hostname === '127.0.0.1';
            if (isDevMode && !user) {
                console.log('üîß DEV MODE: Bypassing auth check');
                hideLoadingScreen();
                document.body.style.visibility = 'visible';
                setupBillingButton(null); // Show disabled button

                // Show VIP Badge in Dev Mode
                const vipBadge = document.getElementById('vip-badge');
                if (vipBadge) vipBadge.style.display = 'flex';
                return;
            }

            if (!user) {
                window.location.href = '/login.html';
                return;
            }

            // Admin/Owner Bypass
            const adminEmails = ['sam.juarez092678@gmail.com', 'jaxnailedit@gmail.com', 'gtmichael9218@gmail.com', 'Montoyamiguel35@gmail.com'];
            const userEmailLower = user.email.toLowerCase().trim();

            if (adminEmails.map(e => e.toLowerCase()).includes(userEmailLower)) {
                console.log('Admin user logged in - bypassing trial check');
                hideLoadingScreen();
                document.body.style.visibility = 'visible';
                showVipAnimation();
                setupBillingButton(user); // Enable button for admins
                return;
            }

            // OPTIMISTIC ACCESS: Show dashboard IMMEDIATELY, verify in background
            // This prevents long loading times and incorrect lockouts
            hideLoadingScreen();
            document.body.style.visibility = 'visible';
            // setupBillingButton(user); // REMOVED: Only show for Admins or Active Subscribers (after check)

            // Background subscription check (non-blocking)
            setTimeout(async () => {
                try {
                    // Get Firebase ID token for server-side verification
                    const idToken = await user.getIdToken();

                    // Use AbortController for timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000); // 20s timeout

                    const response = await fetch('/api/subscription-status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({ email: user.email }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    const status = await response.json();
                    console.log('Subscription status response:', status);
                    console.log('Is VIP?', status.is_vip);

                    // ONLY redirect if we DEFINITIVELY know they're expired
                    // (has_access is explicitly false)
                    if (status.has_access === false) {
                        logEvent(analytics, 'trial_expired', { user_email_domain: user.email.split('@')[1] });
                        logEvent(analytics, 'paywall_hit', { source: 'dashboard', reason: 'trial_expired' });
                        window.location.href = '/upgrade.html?expired=true';
                        return;
                    }

                    // Show appropriate UI based on status
                    if (status.status === 'trialing') {
                        const days = status.days_remaining !== undefined ? status.days_remaining : 3;
                        // Integrate with Critical Events (Economic Calendar)
                        if (window.economicCalendar && window.economicCalendar.addTrialAlert) {
                            window.economicCalendar.addTrialAlert(days);
                        }

                        if (status.login_count > 1) {
                            showPriceNotification();
                        }
                    } else if (status.status === 'active') {
                        // Show Billing Button for Paying Customers
                        setupBillingButton(user);

                        // Show VIP Animation if applicable
                        if (status.is_vip) {
                            showVipAnimation();
                            const vipBadge = document.getElementById('vip-badge');
                            if (vipBadge) vipBadge.style.display = 'flex';
                        }
                    }

                } catch (error) {
                    // Fail CLOSED on error - redirect to upgrade
                    console.warn('Background subscription check failed:', error.name || error.message);
                    logEvent(analytics, 'paywall_hit', { source: 'dashboard', reason: 'check_error' });
                    window.location.href = '/upgrade.html?error=check_failed';
                }
            }, 100); // Slight delay to ensure dashboard renders first
        });



        function showPriceNotification() {
            // Delay slightly so it appears after page loads
            setTimeout(() => {
                const modal = document.createElement('div');
                modal.className = 'price-modal';
                modal.innerHTML = `
                    <div class="price-modal-content">
                        <h2>Welcome Back! üëã</h2>
                        <p>Enjoying PigmentOS? Lock in your access for just</p>
                        <div class="price-highlight">$15<span>/month</span></div>
                        <a href="/upgrade.html" class="price-cta" onclick="window.pigmentAnalytics && window.pigmentAnalytics.logEvent(window.pigmentAnalytics.analytics, 'upgrade_click', {location: 'price_modal'})">Secure My Rate ‚Üí</a>
                        <button class="price-dismiss" onclick="this.parentElement.parentElement.remove()">Maybe later</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }, 1500);
        }

        function hideLoadingScreen() {
            const loader = document.getElementById('loading-screen');
            if (loader) loader.remove();
        }

        function showVipAnimation() {
            console.log('üëë TRIGGERING VIP ANIMATION üëë');
            const overlay = document.createElement('div');
            overlay.className = 'vip-overlay';
            overlay.innerHTML = `
                <div class="vip-text">üëë VIP ACCESS üëë</div>
                <div class="vip-subtext">WELCOME BACK</div>
            `;
            document.body.appendChild(overlay);
            console.log('VIP Overlay added to body');

            // Play a retro sound if desired (optional, keeping it visual for now)
            setTimeout(() => {
                overlay.remove();
                console.log('VIP Overlay removed');
            }, 4000);
        }
    </script>

</html>